#!/bin/bash

CFG="/etc/network/interfaces"
IFACE="ens3"
IDX="$1"

if [ -z "$IDX" ]; then
  echo "Usage: sudo ./switch-primary-ip.sh <alias-number>"
  echo "Example: sudo ./switch-primary-ip.sh 1"
  exit 1
fi

ALIAS="${IFACE}:${IDX}"

if ! grep -q "^auto $ALIAS" "$CFG"; then
  echo "âŒ $ALIAS not found in $CFG"
  exit 1
fi

BACKUP="${CFG}.bak.$(date +%F_%H-%M-%S)"
cp "$CFG" "$BACKUP" || exit 1
echo "âœ” Backup created: $BACKUP"

# Ø§Ø³ØªØ®Ø±Ø§Ø¬ IPÙ‡Ø§
PRIMARY_IP=$(awk "/iface $IFACE inet static/{f=1} f&&/address/{print \$2; exit}" "$CFG")
ALIAS_IP=$(awk "/iface $ALIAS inet static/{f=1} f&&/address/{print \$2; exit}" "$CFG")
NETMASK=$(awk "/iface $IFACE inet static/{f=1} f&&/netmask/{print \$2; exit}" "$CFG")
HWADDR=$(awk "/iface $IFACE inet static/{f=1} f&&/hwaddress/{print \$3; exit}" "$CFG")

GATEWAY="$(echo "$ALIAS_IP" | awk -F. '{print $1"."$2"."$3".1"}')"

# Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯
awk -v IFACE="$IFACE" -v ALIAS="$ALIAS" \
    -v PIP="$PRIMARY_IP" -v AIP="$ALIAS_IP" \
    -v MASK="$NETMASK" -v GW="$GATEWAY" -v HW="$HWADDR" '
BEGIN {skip=0}

/^auto ens3$/ {skip=1; next}
/^iface ens3 inet static/ {next}
/^auto ens3:[0-9]+$/ {skip=1; next}
/^iface ens3:[0-9]+ inet static/ {next}

/^$/ {if(skip){skip=0; next}}

!skip {print}
END {
print ""
print "auto " IFACE
print "iface " IFACE " inet static"
print "    address   " AIP
print "    netmask   " MASK
print "    gateway   " GW
if(HW!="") print "    hwaddress ether " HW
print "    dns-nameservers 1.1.1.1 8.8.8.8"
print ""
print "auto " ALIAS
print "iface " ALIAS " inet static"
print "    address   " PIP
print "    netmask   " MASK
print ""
}
' "$CFG" > /tmp/interfaces.new

mv /tmp/interfaces.new "$CFG"

echo "âœ” interfaces file updated"

echo "â–¶ Restarting networking..."
systemctl restart networking || service networking restart

echo "ðŸŽ‰ Done. New primary IP:"
ip -4 addr show dev ens3
