#!/bin/bash

IFACE="ens3"
CFG="/etc/network/interfaces"
BACKUP="/etc/network/interfaces.bak.$(date +%F_%H-%M)"

TARGET_ALIAS="$1"

if [ -z "$TARGET_ALIAS" ]; then
  echo "Usage: sudo ./switch-primary-ip.sh <alias-number>"
  echo "Example: sudo ./switch-primary-ip.sh 1   # ens3:1 becomes primary"
  exit 1
fi

ALIAS_IFACE="${IFACE}:${TARGET_ALIAS}"

echo "â–¶ Switching primary IP to $ALIAS_IFACE"
echo "â–¶ Backup: $BACKUP"

cp "$CFG" "$BACKUP" || exit 1

# Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ù„Ø§Ú© ens3
PRIMARY_BLOCK=$(awk "
/^auto $IFACE$/ {flag=1}
/^$/ && flag {print; exit}
flag {print}
" "$CFG")

# Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ù„Ø§Ú© ens3:X
ALIAS_BLOCK=$(awk "
/^auto $ALIAS_IFACE$/ {flag=1}
/^$/ && flag {print; exit}
flag {print}
" "$CFG")

if [ -z "$ALIAS_BLOCK" ]; then
  echo "âŒ Alias $ALIAS_IFACE not found"
  exit 1
fi

# Ú¯Ø±ÙØªÙ† IP Ùˆ netmask
NEW_IP=$(echo "$ALIAS_BLOCK" | awk '/address/ {print $2}')
NETMASK=$(echo "$ALIAS_BLOCK" | awk '/netmask/ {print $2}')
GATEWAY=$(echo "$NEW_IP" | awk -F. '{print $1"."$2"."$3".1"}')

# Ø¨Ù„Ø§Ú© Ø¬Ø¯ÛŒØ¯ ens3
NEW_PRIMARY_BLOCK=$(cat <<EOF
auto $IFACE
iface $IFACE inet static
    address   $NEW_IP
    netmask   $NETMASK
    gateway   $GATEWAY
    hwaddress ether $(echo "$PRIMARY_BLOCK" | awk '/hwaddress/ {print $3}')
    dns-nameservers 1.1.1.1 8.8.8.8

EOF
)

# Ø¨Ù„Ø§Ú© Ø¬Ø¯ÛŒØ¯ alias
OLD_PRIMARY_IP=$(echo "$PRIMARY_BLOCK" | awk '/address/ {print $2}')

NEW_ALIAS_BLOCK=$(cat <<EOF
auto $ALIAS_IFACE
iface $ALIAS_IFACE inet static
    address   $OLD_PRIMARY_IP
    netmask   $NETMASK

EOF
)

# Ø­Ø°Ù Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
sed -i "/^auto $IFACE$/,/^$/d" "$CFG"
sed -i "/^auto $ALIAS_IFACE$/,/^$/d" "$CFG"

# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
echo "$NEW_PRIMARY_BLOCK" >> "$CFG"
echo "$NEW_ALIAS_BLOCK" >> "$CFG"

echo "âœ… File updated."

echo "â–¶ Restarting network..."
systemctl restart networking || service networking restart

echo "ğŸ‰ Done. New primary IP:"
ip -4 addr show dev $IFACE
