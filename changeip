#!/bin/bash

CFG="/etc/network/interfaces"
IFACE="ens3"

if [ "$EUID" -ne 0 ]; then
  echo "âŒ Run as root"
  exit 1
fi

# Ú¯Ø±ÙØªÙ† IPÙ‡Ø§ÛŒ ens3 Ùˆ aliasÙ‡Ø§
mapfile -t IFACES < <(awk '
/^auto ens3$/ {print "ens3"}
/^auto ens3:[0-9]+$/ {print $2}
' "$CFG")

if [ ${#IFACES[@]} -eq 0 ]; then
  echo "âŒ No ens3 interfaces found"
  exit 1
fi

declare -A IPS
declare -A NETMASKS
declare -A GATEWAYS
HWADDR=""

for i in "${IFACES[@]}"; do
  IPS[$i]=$(awk "/iface $i inet static/{f=1} f&&/address/{print \$2; exit}" "$CFG")
  NETMASKS[$i]=$(awk "/iface $i inet static/{f=1} f&&/netmask/{print \$2; exit}" "$CFG")
  [ "$i" = "ens3" ] && \
    GATEWAYS[$i]=$(awk "/iface $i inet static/{f=1} f&&/gateway/{print \$2; exit}" "$CFG")
  HWADDR=$(awk "/iface ens3 inet static/{f=1} f&&/hwaddress/{print \$3; exit}" "$CFG")
done

echo "==== Available IPs ===="
PS3="Select IP to set as PRIMARY (ens3): "

OPTIONS=()
for i in "${IFACES[@]}"; do
  OPTIONS+=("$i â†’ ${IPS[$i]}")
done

select CHOICE in "${OPTIONS[@]}"; do
  [ -n "$CHOICE" ] && break
done

TARGET_IFACE=$(echo "$CHOICE" | awk '{print $1}')
NEW_PRIMARY_IP="${IPS[$TARGET_IFACE]}"
NETMASK="${NETMASKS[$TARGET_IFACE]}"
OLD_PRIMARY_IP="${IPS[ens3]}"

if [ "$TARGET_IFACE" = "ens3" ]; then
  echo "âœ” Already primary. Nothing to do."
  exit 0
fi

# Ø³Ø§Ø®Øª gateway Ø¬Ø¯ÛŒØ¯
NEW_GATEWAY=$(echo "$NEW_PRIMARY_IP" | awk -F. '{print $1"."$2"."$3".1"}')

BACKUP="$CFG.bak.$(date +%F_%H-%M-%S)"
cp "$CFG" "$BACKUP"
echo "âœ” Backup saved: $BACKUP"

# Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ ÙØ§ÛŒÙ„
awk -v PIP="$NEW_PRIMARY_IP" -v OIP="$OLD_PRIMARY_IP" \
    -v MASK="$NETMASK" -v GW="$NEW_GATEWAY" -v HW="$HWADDR" \
    -v TGT="$TARGET_IFACE" '
BEGIN {skip=0}
/^auto ens3($|:)/ {skip=1; next}
/^iface ens3($|:)/ {next}
/^$/ {if(skip){skip=0; next}}
!skip {print}
END {
print ""
print "auto ens3"
print "iface ens3 inet static"
print "    address   " PIP
print "    netmask   " MASK
print "    gateway   " GW
if(HW!="") print "    hwaddress ether " HW
print "    dns-nameservers 1.1.1.1 8.8.8.8"
print ""
idx=0
print "auto ens3:0"
print "iface ens3:0 inet static"
print "    address   " OIP
print "    netmask   " MASK
}
' "$CFG" > /tmp/interfaces.new

mv /tmp/interfaces.new "$CFG"

echo "âœ” interfaces file updated"

echo "â–¶ Restarting network..."
systemctl restart networking || service networking restart

echo "ğŸ‰ Done!"
ip -4 addr show ens3
